# Mysql原理



## Mysql系统框架

> Mysql是关系型数据库,用于存储数据,其包含许多模块用于处理连接、解析sql、优化sql、执行sql、存储数据等。

### 连接模块

> 市面上许多mysql连接驱动(客户端),程序通过这些连接驱动与mysql建立连接,从而进行通信。频繁的连接断开操作会使mysql不堪重负,因此产生了连接池模块,池中的连接可以重复利用。
>
> 不同的mysql性能不一样,所以合理配置连接池可以较大程度的发挥mysql性能,其中有两个参数：最大连接数、可接收数据的最大报文长度。

### mysql解析器

> 解析sql语句,如果sql不能解析,则会返回错误客户端。

### mysql优化器

> sql解析完成之后，mysql会根据自身的数据结构、索引情况来优化、重组我们的sql。

### 存储引擎

> 存储引擎有很多种,根据不同的场景旋转合适的存储引擎。
>
> 有读取快的、一致性高的、功能齐全的、量级轻的。
>
> 其中innodb  性能较好、可靠作为默认存储引擎

### 其他

> 缓存、安全、恢复、集群等模块



## mysql写入原理

> 客户端发送sql,mysql解析器对sql进行解析,解析成功后sql优化器对sql进行优化、重组,最后交给存储引擎进行数据存储。
>
> 那么在存储引擎中做哪些呢？
>
> 拿到优化后的sql执行计划会传给存储引擎，存储引擎的执行器会按照对应命令运行。
>
> 内存操作相较于磁盘io拥有较高的性能,所以一切的逻辑处理和读写操作都在内存中完成,这块内存缓存区域称作为buffer pool。
>
> 为了支持数据回滚,在数据写入内存缓存区之前会将数据回滚操作放入undo log文件中。
>
> 回滚操作写入完成后，innodb会开启线程将内存中的数据读出来，并写入.ibd文件。
>
> 为了避免数据库宕机造成内存中数据丢失，innodb会将写入日志记录在Redolog buffer中，并借助特定的刷盘策略将写入日志持久化到redolog中。

- 回滚操作写入Undolog文件                        （undolog除了用于回滚记录，还用于mvcc替换不必要的锁）
- 逻辑操作和写入操作，写入内存缓存区      （内存操作快于磁盘io）
- 写入操作记录redologbuffer
- redologbuffer 刷盘，记录进redolog  （数据库重启后优先将redolog中未持久化到.ibd的数据初始化）
- 记录数据变更历史，记录进binlog
- commit提交事务，为redolog记录commit标志
- 缓存数据区数据持久化到磁盘XXX.ibd文件

#### redologbuffer刷盘策略

> 可使用如下命令查看设置当前数据据的刷盘策略

```sql
show VARIABLES like 'innodb_flush_log_at_trx_commit%';

set GLOBAL binnodb_flush_log_at_trx_commit = 1;
```

-- redolog 刷盘策略   
-- 1 ：每当事务提交后，会将’更新写入信息‘写入到redolog buffer中 随后添加到操作系统内存中并执行刷盘操作
-- 0 2 策略一致型不是很强  0 只会写入redologbuffer中，每隔一秒放入系统内存并进行刷盘操作
-- 2 只会写入系统内存  并隔一段时间刷盘



## mysql存储结构



















## Mysql优化































